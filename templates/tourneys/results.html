{% extends "main/layout.html" %}

{% block title %} Results {% endblock %}

{% block main %}
    <style>
        .select2-results {
            font-size: .9em;
        }
    </style>
    <script>
        function showResults(res) {
            $("#results").html(res.html);
            // console.log(res.html);
        }
    </script>
    <div class="fullspace text-center pt-4">
        <div class="container-md">
            <div class="container">
                <h1>{{ tourney.info.name }}</h1>
                <form
                    class="bg-white shadow rounded border border-dark border-2 mx-auto d-flex flex-column"
                    style="min-width: 400px; max-width: fit-content; overflow: hidden;"
                    keepinputs="1"
                    onsuccess="showResults"
                    enhance
                >
                    <div class="p-1 border-bottom border-dark" style="background-color: rgb(228, 228, 228);">
                        <h5 class="mb-0">Results</h5>
                    </div>
                    <div class="bg-white p-2">
                        <select class="select3" name="resultstype">
                            {% for grade in range(tourney.min_grade, tourney.max_grade+1) %}
                                <optgroup label="{{ ext.ordinal(grade) }} Grade:">
                                    {% if tourney.info.results.individual %}
                                        {% for test in ['NS', 'CA', 'GM', 'GS'] %}
                                            <option value="I-{{ grade }}-{{ test }}">
                                                {{ ext.ordinal(grade) }} Grade {{ ext.testName[test] }}
                                            </option>
                                        {% endfor %}
                                    {% endif %}
                                </optgroup>
                                {% if (grade == 5 or grade == 8) and tourney.info.results.schoollevel %}
                                    {% set sl = "Elementary" if grade == 5 else "Middle School" %}
                                    <optgroup label="All {{ sl }}:">
                                        {% for test in ['NS', 'CA', 'GM', 'GS'] %}
                                            <option value="I-{{ sl[0] }}-{{ test }}">
                                                {{ sl }} {{ ext.testName[test] }}
                                            </option>
                                        {% endfor %}
                                    </optgroup>
                                {% endif %}
                            {% endfor %}
                            {% if tourney.info.results.eventsweepstakes or tourney.info.results.overallsweepstakes %}
                                {% if tourney.min_grade <= 5 %}
                                    <optgroup label="Elementary Sweepstakes:">
                                        {% if tourney.info.results.eventsweepstakes %}
                                            {% for test in ['NS', 'CA', 'GM', 'GS'] %}
                                                <option value="S-E-{{ test }}">
                                                    Elementary {{ ext.testName[test] }} Sweepstakes
                                                </option>
                                            {% endfor %}
                                        {% endif %}
                                        {% if tourney.info.results.overallsweepstakes %}
                                            <option value="S-E-O">Elementary Overall Sweepstakes</option>
                                        {% endif %}
                                    </optgroup>
                                {% endif %}
                                {% if tourney.max_grade >= 6 %}
                                    <optgroup label="Middle School Sweepstakes:">
                                        {% if tourney.info.results.eventsweepstakes %}
                                            {% for test in ['NS', 'CA', 'GM', 'GS'] %}
                                                <option value="S-M-{{ test }}">
                                                    Middle School {{ ext.testName[test] }} Sweepstakes
                                                </option>
                                            {% endfor %}
                                        {% endif %}
                                        {% if tourney.info.results.overallsweepstakes %}
                                            <option value="S-M-O">Middle School Overall Sweepstakes</option>
                                        {% endif %}
                                    </optgroup>
                                {% endif %}
                            {% endif %}
                        </select>
                        <style>
                            .select2-results__option--group {
                                overflow: hidden;
                            }
                            .select2-results__options--nested {
                                max-height: 0px;
                                transition: max-height .5s ease-in-out;
                            }
                            .select2-results__options--nested.vis {
                                max-height: 300px;
                            }
                            strong.select2-results__group:hover {
                                background-color: lightblue;
                                cursor: pointer;
                            }
                            strong.select2-results__group:active {
                                background-color: rgb(77, 77, 255);
                            }
                            .transition-none {
                                transition: none !important;
                            }
                        </style>
                        <script>
                            $(document).ready(() => {
                                function k() {
                                    let v = $(".select2-search input").val();
                                    if (v) {
                                        $(".select2-results__options--nested").addClass("transition-none");
                                        $(".select2-results__options--nested").addClass("vis");
                                        setTimeout(() => {
                                            $(".select2-results__options--nested").removeClass("transition-none");
                                        }, 10);
                                    } else
                                        $(".select2-results__options--nested").removeClass("vis");
                                }
                                var currentQuery = "";
                                $("select.select3").select2()
                                .on('select2:closing', function (e) {
                                    currentQuery = $('.select2-search input').prop('value');
                                }).on('select2:open', function (e) {
                                    setTimeout(() => {
                                        $('.select2-search input').val(currentQuery)
                                        .on("change", k).on("input", k)
                                        .trigger('change').trigger("input");
                                    }, 0);
                                }).on('select2:select', function (e) {
                                    $('.select2-search input').val('').trigger('change');
                                });
                                $("body").on("click", "strong.select2-results__group", (e) => {
                                    $(e.currentTarget).next("ul").toggleClass("vis");
                                });
                            });
                        </script>
                        <button class="btn btn-lg btn-success w-100 mt-2" type="submit">View Results</button>
                    </div>
                </form>
                <div class="mt-3" id="results">

                </div>
            </div>
        </div>
    </div>
{% endblock %}

